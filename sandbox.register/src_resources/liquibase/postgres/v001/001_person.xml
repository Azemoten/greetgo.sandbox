<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet author="pompei" id="create-table-user_params">
    <sql endDelimiter=";;"><![CDATA[
      create table user_params (
        person_id varchar(30) not null,
        name varchar(50) not null,
        value varchar(1000),
        primary key(person_id, name)
      )
    ]]></sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-all_params">
    <sql endDelimiter=";;"><![CDATA[
      create table all_params (
        name varchar(50) not null,
        value_str varchar(1000),
        value_blob byTea,
        primary key(name)
      )
    ]]></sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-person">
    <sql endDelimiter=";;"><![CDATA[
      create table person (
        id varchar(30) not null primary key,
        username varchar(100) not null,
        surname varchar(255),
        name varchar(255),
        patronymic varchar(255),
        birth_date date,
        encoded_password varchar(255),
        blocked smallint not null default 1
      )
    ]]></sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-user_can">
    <sql endDelimiter=";;"><![CDATA[
      create table user_can (
        user_can varchar(50) primary key,
        description text,
        actual smallint not null default 1
      )
    ]]></sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-person_cans">
    <sql endDelimiter=";;"><![CDATA[
      create table person_cans (
        person_id varchar(50) references person,
        user_can varchar(50) references user_can,
        primary key(person_id, user_can)
      )
    ]]></sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-charm">
    <sql endDelimiter=";;">
      create table charm(
      id serial primary key,
      name varchar(100) ,
      description varchar(255),
      CONSTRAINT name_unique UNIQUE (name),
      energy float
      )
    </sql>
  </changeSet>
  <changeSet author="pompei" id="create-type-gender">
    <sql endDelimiter=";;">
      create type gender as ENUM('MALE', 'FEMALE');
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-type-address">
    <sql endDelimiter=";;">
      create type address as ENUM('FACT', 'REG');
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-type-phone">
    <sql endDelimiter=";;">
      create type phone as ENUM('HOME', 'WORK', 'MOBILE');
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-client">
    <sql endDelimiter=";;">
      create table client(
      id serial PRIMARY KEY,
      surname varchar(100) NOT NULL,
      name varchar(100) NOT NULL,
      patronymic varchar(200),
      gender gender NOT NULL,
      birth_date date,
      actual boolean DEFAULT true,
      charm integer references charm(id),
      cia_id varchar(200)
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-client_addr">
    <sql endDelimiter=";;">
      create table client_addr(
      client integer references client(id),
      type address,
      street varchar(255),
      house varchar(255),
      flat varchar(255)
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-client_phone">
    <sql endDelimiter=";;">
      create table client_phone(
      client integer references client(id),
      number varchar(100),
      type phone
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-client_account">
    <sql endDelimiter=";;">
      create table client_account(
      id serial PRIMARY KEY,
      client integer references client(id),
      money float,
      number varchar(100),
      registered_at timestamp,
      cia_id varchar(100)
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-transaction_type">
    <sql endDelimiter=";;">
      create table transaction_type(
      id serial PRIMARY KEY,
      code varchar(100),
      name varchar(255),
      CONSTRAINT transaction_name_unique UNIQUE (name)
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-client_account_transaction">
    <sql endDelimiter=";;">
      create table client_account_transaction(
      id serial PRIMARY KEY,
      account integer references client_account(id),
      money float,
      finished_at timestamp,
      type integer references transaction_type(id)
      );
    </sql>
  </changeSet>


  <changeSet author="pompei" id="create-table-migration_client">
    <sql endDelimiter=";;">
      create table migration_client(
      id serial not null,
      cia_id varchar(200) not null,
      name varchar(100) not null,
      surname varchar(100) not null,
      patronymic varchar(100),
      gender varchar(10) not null,
      birth date not null,
      charm_text varchar(200) not null,
      status int default 0,
      charm int,
      actual smallint default 1,
      inserted_at timestamp default CURRENT_TIMESTAMP
      )
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-migration_transaction">
    <sql endDelimiter=";;">
      create table migration_transaction(
      money float not null,
      finished_at varchar(200),
      transaction_type varchar(200) not null,
      transaction_id int,
      account_number varchar(200),
      status int default 0,
      inserted_at timestamp default current_timestamp
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-migration_account">
    <sql endDelimiter=";;">
      create table migration_account(
      cia_id varchar(200) not null,
      money float,
      registered_at varchar(200) not null,
      account_number varchar(200) not null,
      status int default 0,
      inserted_at timestamp default current_timestamp
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-migration_phone">
    <sql endDelimiter=";;">
      create table migration_phone(
      cia_id varchar(200) not null,
      number varchar(200) not null,
      type varchar(10) not null,
      status int default 0,
      actual smallint not null default 1,
      inserted_at timestamp default current_timestamp
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-table-migration_address">
    <sql endDelimiter=";;">
      create table migration_address(
      cia_id varchar(200) not null,
      type varchar(10) not null,
      street varchar(200) not null,
      house varchar(200) not null,
      flat varchar(200) not null,
      status int default 0,
      actual smallint not null default 1,
      inserted_at timestamp default current_timestamp
      );
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-index-client_ciaId">
    <sql endDelimiter=";;">
      CREATE INDEX idx_migration_ciaId
      ON migration_client(cia_id);
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-index-Realclient_ciaId">
    <sql endDelimiter=";;">
      CREATE INDEX idx_client_ciaId
      ON client(cia_id);
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-index_ciaId">
    <sql endDelimiter=";;">
      CREATE INDEX idx_migration_account_ciaId
      ON migration_account(cia_id);
    </sql>
  </changeSet>

  <changeSet author="pompei" id="create-index-account_accountNumber">
    <sql endDelimiter=";;">
      CREATE INDEX idx_account_number
      ON migration_transaction(account_number);
    </sql>
  </changeSet>

</databaseChangeLog>
